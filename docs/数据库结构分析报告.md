# CoreBank æ•°æ®åº“ç»“æ„åˆ†ææŠ¥å‘Š

## ğŸ“Š æ•°æ®åº“æ¦‚è§ˆ

**æ•°æ®åº“ç‰ˆæœ¬**: PostgreSQL 16.8  
**æ€»è¡¨æ•°**: 11ä¸ªè¡¨  
**æ•°æ®åº“å**: corebank  
**ç”¨æˆ·**: corebank_user  

## ğŸ“ˆ æ•°æ®ç»Ÿè®¡

| è¡¨å | è¡Œæ•° | è¯´æ˜ |
|------|------|------|
| users | 15 | ç”¨æˆ·åŸºç¡€ä¿¡æ¯ |
| accounts | 16 | é“¶è¡Œè´¦æˆ· |
| transaction_groups | 34 | äº¤æ˜“ç»„ï¼ˆåŒè®°è´¦æ³•ï¼‰ |
| transaction_entries | 68 | äº¤æ˜“æ¡ç›®ï¼ˆåŒè®°è´¦æ³•ï¼‰ |
| investment_products | 6 | æŠ•èµ„äº§å“ |
| investment_holdings | 8 | æŠ•èµ„æŒä»“ |
| investment_transactions | 15 | æŠ•èµ„äº¤æ˜“ |
| user_profiles | 6 | ç”¨æˆ·ä¸ªäººä¿¡æ¯ |
| user_risk_assessments | 4 | é£é™©è¯„ä¼° |
| product_nav_history | 93 | äº§å“å‡€å€¼å†å² |
| alembic_version | 2 | æ•°æ®åº“ç‰ˆæœ¬ç®¡ç† |

## ğŸ—ï¸ æ ¸å¿ƒè¡¨ç»“æ„åˆ†æ

### 1. ç”¨æˆ·ç®¡ç†æ¨¡å—

#### users è¡¨ - ç”¨æˆ·åŸºç¡€ä¿¡æ¯
```sql
- id (UUID, PK): ç”¨æˆ·å”¯ä¸€æ ‡è¯†
- username (VARCHAR(255), UNIQUE): ç”¨æˆ·å
- hashed_password (VARCHAR(255)): å“ˆå¸Œå¯†ç 
- role (user_role ENUM): ç”¨æˆ·è§’è‰² (user/admin)
- is_active (BOOLEAN): æ˜¯å¦æ¿€æ´»
- deleted_at (TIMESTAMP): è½¯åˆ é™¤æ—¶é—´
- last_login_at (TIMESTAMP): æœ€åç™»å½•æ—¶é—´
- created_at/updated_at: æ—¶é—´æˆ³
```

**ç´¢å¼•ä¼˜åŒ–**:
- ä¸»é”®ç´¢å¼•: users_pkey
- å”¯ä¸€ç´¢å¼•: users_username_key
- å¤åˆç´¢å¼•: idx_users_active_role
- å•åˆ—ç´¢å¼•: è§’è‰²ã€æ¿€æ´»çŠ¶æ€ã€åˆ é™¤æ—¶é—´ã€æœ€åç™»å½•

**è§¦å‘å™¨**: update_users_updated_at (è‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³)

#### user_profiles è¡¨ - ç”¨æˆ·ä¸ªäººä¿¡æ¯
```sql
- id (UUID, PK): ä¸»é”®
- user_id (UUID, FK, UNIQUE): å…³è”ç”¨æˆ·
- real_name (VARCHAR(100)): çœŸå®å§“å
- english_name (VARCHAR(100)): è‹±æ–‡å§“å
- id_type/id_number: è¯ä»¶ç±»å‹å’Œå·ç 
- country/ethnicity/gender: å›½å®¶/æ°‘æ—/æ€§åˆ«
- birth_date/birth_place: å‡ºç”Ÿæ—¥æœŸ/åœ°ç‚¹
- phone/email/address: è”ç³»æ–¹å¼
```

**ç´¢å¼•ä¼˜åŒ–**: å§“åã€è¯ä»¶å·ã€æ‰‹æœºã€é‚®ç®±éƒ½æœ‰ç´¢å¼•

### 2. è´¦æˆ·ç®¡ç†æ¨¡å—

#### accounts è¡¨ - é“¶è¡Œè´¦æˆ·
```sql
- id (UUID, PK): è´¦æˆ·å”¯ä¸€æ ‡è¯†
- account_number (VARCHAR(20), UNIQUE): è´¦æˆ·å·
- user_id (UUID, FK): å…³è”ç”¨æˆ·
- account_type (ENUM): è´¦æˆ·ç±»å‹ (checking/savings)
- balance (NUMERIC(19,4)): è´¦æˆ·ä½™é¢
- created_at/updated_at: æ—¶é—´æˆ³
```

**çº¦æŸæ£€æŸ¥**:
- ä½™é¢éè´Ÿ: accounts_balance_check
- è´¦æˆ·ç±»å‹é™åˆ¶: accounts_account_type_check

**ç´¢å¼•ä¼˜åŒ–**: ç”¨æˆ·IDã€è´¦æˆ·ç±»å‹ã€æ›´æ–°æ—¶é—´

### 3. äº¤æ˜“ç³»ç»Ÿæ¨¡å—ï¼ˆåŒè®°è´¦æ³•ï¼‰

#### transaction_groups è¡¨ - äº¤æ˜“ç»„
```sql
- id (UUID, PK): äº¤æ˜“ç»„ID
- group_type (VARCHAR(50)): äº¤æ˜“ç±»å‹
- description (TEXT): äº¤æ˜“æè¿°
- total_amount (NUMERIC(19,4)): æ€»é‡‘é¢
- status (ENUM): äº¤æ˜“çŠ¶æ€ (pending/completed/failed/cancelled)
- reference_id (UUID): å‚è€ƒID
- created_at/updated_at: æ—¶é—´æˆ³
```

#### transaction_entries è¡¨ - äº¤æ˜“æ¡ç›®
```sql
- id (UUID, PK): æ¡ç›®ID
- transaction_group_id (UUID, FK): å…³è”äº¤æ˜“ç»„
- account_id (UUID, FK): å…³è”è´¦æˆ·
- entry_type (ENUM): æ¡ç›®ç±»å‹ (debit/credit)
- amount (NUMERIC(19,4)): é‡‘é¢
- balance_after (NUMERIC(19,4)): äº¤æ˜“åä½™é¢
- description (TEXT): æè¿°
```

**çº¦æŸæ£€æŸ¥**:
- é‡‘é¢å¿…é¡»ä¸ºæ­£: ck_transaction_entries_amount_positive

**è§¦å‘å™¨**:
- validate_transaction_entries_balance: éªŒè¯äº¤æ˜“ç»„å¹³è¡¡

### 4. æŠ•èµ„ç®¡ç†æ¨¡å—

#### investment_products è¡¨ - æŠ•èµ„äº§å“
```sql
- id (UUID, PK): äº§å“ID
- product_code (VARCHAR(50), UNIQUE): äº§å“ä»£ç 
- name (VARCHAR(200)): äº§å“åç§°
- product_type (ENUM): äº§å“ç±»å‹ (money_fund/fixed_term/mutual_fund/insurance)
- risk_level (INTEGER): é£é™©ç­‰çº§ (1-5)
- expected_return_rate (NUMERIC(5,4)): é¢„æœŸæ”¶ç›Šç‡
- min/max_investment_amount: æœ€å°/æœ€å¤§æŠ•èµ„é‡‘é¢
- investment_period_days: æŠ•èµ„æœŸé™
- is_active (BOOLEAN): æ˜¯å¦æ¿€æ´»
- features (JSONB): äº§å“ç‰¹æ€§
```

**çº¦æŸæ£€æŸ¥**:
- é£é™©ç­‰çº§: 1-5
- æŠ•èµ„é‡‘é¢: æœ€å°é‡‘é¢ä¸ºæ­£ï¼Œæœ€å¤§é‡‘é¢â‰¥æœ€å°é‡‘é¢
- æŠ•èµ„æœŸé™: ä¸ºæ­£æ•°æˆ–NULL

#### investment_holdings è¡¨ - æŠ•èµ„æŒä»“
```sql
- id (UUID, PK): æŒä»“ID
- user_id (UUID, FK): ç”¨æˆ·ID
- account_id (UUID, FK): è´¦æˆ·ID
- product_id (UUID, FK): äº§å“ID
- shares (NUMERIC(19,8)): æŒæœ‰ä»½é¢
- average_cost (NUMERIC(19,4)): å¹³å‡æˆæœ¬
- total_invested: æ€»æŠ•èµ„é‡‘é¢
- current_value: å½“å‰ä»·å€¼
- unrealized_gain_loss: æœªå®ç°ç›ˆäº
- realized_gain_loss: å·²å®ç°ç›ˆäº
- purchase_date: è´­ä¹°æ—¥æœŸ
- maturity_date: åˆ°æœŸæ—¥æœŸ
- status (ENUM): æŒä»“çŠ¶æ€ (active/matured/redeemed)
```

**å”¯ä¸€çº¦æŸ**: uq_user_account_product_purchase (é˜²é‡å¤è´­ä¹°)

## ğŸ”— å¤–é”®å…³ç³»å›¾

```
users (1) â”€â”€â†’ (N) accounts
users (1) â”€â”€â†’ (1) user_profiles
users (1) â”€â”€â†’ (N) user_risk_assessments
users (1) â”€â”€â†’ (N) investment_holdings
users (1) â”€â”€â†’ (N) investment_transactions

accounts (1) â”€â”€â†’ (N) transaction_entries
accounts (1) â”€â”€â†’ (N) investment_holdings
accounts (1) â”€â”€â†’ (N) investment_transactions

transaction_groups (1) â”€â”€â†’ (N) transaction_entries

investment_products (1) â”€â”€â†’ (N) investment_holdings
investment_products (1) â”€â”€â†’ (N) investment_transactions
investment_products (1) â”€â”€â†’ (N) product_nav_history

investment_holdings (1) â”€â”€â†’ (N) investment_transactions
```

## ğŸ›¡ï¸ æ•°æ®å®Œæ•´æ€§ä¿éšœ

### 1. ä¸»é”®çº¦æŸ
- æ‰€æœ‰è¡¨éƒ½ä½¿ç”¨UUIDä½œä¸ºä¸»é”®
- ä½¿ç”¨gen_random_uuid()è‡ªåŠ¨ç”Ÿæˆ

### 2. å¤–é”®çº¦æŸ
- 13ä¸ªå¤–é”®çº¦æŸç¡®ä¿å¼•ç”¨å®Œæ•´æ€§
- çº§è”åˆ é™¤ç­–ç•¥ä¿æŠ¤æ•°æ®ä¸€è‡´æ€§

### 3. æ£€æŸ¥çº¦æŸ
- ä½™é¢éè´Ÿæ£€æŸ¥
- é‡‘é¢æ­£æ•°æ£€æŸ¥
- æšä¸¾å€¼é™åˆ¶
- ä¸šåŠ¡è§„åˆ™éªŒè¯

### 4. å”¯ä¸€çº¦æŸ
- ç”¨æˆ·åå”¯ä¸€
- è´¦æˆ·å·å”¯ä¸€
- äº§å“ä»£ç å”¯ä¸€
- ç”¨æˆ·ä¸ªäººä¿¡æ¯ä¸€å¯¹ä¸€

### 5. ç´¢å¼•ä¼˜åŒ–
- ä¸»é”®ç´¢å¼•
- å¤–é”®ç´¢å¼•
- ä¸šåŠ¡æŸ¥è¯¢ç´¢å¼•
- å¤åˆç´¢å¼•ä¼˜åŒ–

## ğŸ”§ æ•°æ®åº“ç‰¹æ€§

### 1. è‡ªåŠ¨æ—¶é—´æˆ³
- æ‰€æœ‰è¡¨éƒ½æœ‰created_atå’Œupdated_at
- è§¦å‘å™¨è‡ªåŠ¨ç»´æŠ¤updated_at

### 2. è½¯åˆ é™¤æ”¯æŒ
- usersè¡¨æ”¯æŒè½¯åˆ é™¤
- deleted_atå­—æ®µæ ‡è®°åˆ é™¤æ—¶é—´

### 3. JSONBæ”¯æŒ
- investment_products.featuresä½¿ç”¨JSONB
- æ”¯æŒçµæ´»çš„äº§å“ç‰¹æ€§å­˜å‚¨

### 4. æšä¸¾ç±»å‹
- ç”¨æˆ·è§’è‰²: user_role
- è´¦æˆ·ç±»å‹: account_type_enum
- äº¤æ˜“çŠ¶æ€: transaction_status_enum
- æ¡ç›®ç±»å‹: entry_type_enum
- äº§å“ç±»å‹: product_type_enum
- æŒä»“çŠ¶æ€: holding_status_enum

## âœ… åˆ†æå·¥å…·çŠ¶æ€ç¡®è®¤

**æ•°æ®åº“åˆ†æå·¥å…·ä¾ç„¶å¯ç”¨** âœ…

1. **è¿æ¥æ­£å¸¸**: PostgreSQL 16.8è¿è¡Œæ­£å¸¸
2. **æƒé™æ­£ç¡®**: corebank_userå…·æœ‰å®Œæ•´è®¿é—®æƒé™
3. **æ•°æ®å®Œæ•´**: æ‰€æœ‰11ä¸ªè¡¨ç»“æ„å®Œæ•´ï¼Œæ•°æ®ä¸€è‡´
4. **ç´¢å¼•å¥åº·**: æ‰€æœ‰ç´¢å¼•æ­£å¸¸å·¥ä½œ
5. **çº¦æŸæœ‰æ•ˆ**: æ‰€æœ‰çº¦æŸå’Œè§¦å‘å™¨æ­£å¸¸è¿è¡Œ

**å»ºè®®çš„åˆ†æå‘½ä»¤**:
```bash
# æŸ¥çœ‹è¡¨ç»“æ„
podman exec corebank_postgres psql -U corebank_user -d corebank -c "\d table_name"

# æŸ¥çœ‹æ•°æ®ç»Ÿè®¡
podman exec corebank_postgres psql -U corebank_user -d corebank -c "SELECT COUNT(*) FROM table_name"

# æŸ¥çœ‹å¤–é”®å…³ç³»
podman exec corebank_postgres psql -U corebank_user -d corebank -c "\d+ table_name"
```

æ•°æ®åº“ç»“æ„è®¾è®¡åˆç†ï¼Œå®ç°äº†å®Œæ•´çš„é“¶è¡Œä¸šåŠ¡åŠŸèƒ½ï¼Œæ”¯æŒç”¨æˆ·ç®¡ç†ã€è´¦æˆ·ç®¡ç†ã€äº¤æ˜“å¤„ç†å’ŒæŠ•èµ„ç†è´¢çš„å…¨æµç¨‹æ“ä½œã€‚
